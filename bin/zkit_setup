#!/usr/bin/env bash

#{{
# Setup zkit environment
#}}

## default_settings
export ZKIT=${ZKIT=${HOME}/.zkit}
zkit_debug=false
zkit_autoupdate=true
ZKIT_PRIVATE=${HOME}/.zkit_private
ZKIT_PRIVATE_REPO=

## import user settings
rc="${HOME}/.zkitrc"
if [[ -r $rc ]]; then
    source $rc
fi

rc="${ZKIT_PRIVATE}/zkitrc"
if [[ -r $rc ]]; then
    source $rc
fi


## check ZKIT
if [[ ! -d ${ZKIT} ]]; then
    echo "Cannot find ZKIT directory: $ZKIT"
    exit 1
fi

## load functions
source ${ZKIT}/bash/functions/zkit_core
require utils

## default setups
if [[ -z ${zkit_setups[*]} ]]; then
    if __zkit_have zsh; then
	zkit_setups=( bash zsh )
    else
	zkit_setups=( bash )
    fi
fi

## update zkit
if $zkit_autoupdate && [[ -d ${ZKIT}/.git ]]; then
    __zkit_msg "++ Updating ZKIT:" $name
    ( cd ${ZKIT} ; __zkit_run git pull )
    chmod -R og-rwx ${ZKIT}
fi

## make var directories
mkdir -p ${ZKIT}/var/{cache,tmp}

## pull private settings
if [[ -n ${ZKIT_PRIVATE_REPO} ]]; then
    if [[ -d ${ZKIT_PRIVATE}/.git ]]; then
	__zkit_msg "++ Updating private"
	( cd ${ZKIT_PRIVATE} ; __zkit_run git pull )
    else
	__zkit_err "++ Downloading private from ${ZKIT_PRIVATE_REPO}"
	__zkit_run git clone ${ZKIT_PRIVATE_REPO} ${ZKIT_PRIVATE} || exit 1
    fi
    chmod -R og-rwx ${ZKIT_PRIVATE}
fi


## get host setup params 
d=${ZKIT_PRIVATE}/intrinsics
host=${d}/host-${HOSTNAME}
if [[ ! -r ${host} ]]; then
    host=${d}/host-${HOSTNAME%%.*}
    if [[ ! -r ${host} ]]; then
	host=
    fi
fi
if [[ -n ${host} ]]; then
    __zkit_msg "++ Applying host intrinsic:" ${host}
    source ${host}
fi

## run setup scripts
for name in "${zkit_setups[@]}" "${zkit_setups_local[@]}"; do
    if [[ -r ${ZKIT}/setup.d/${name}.sh ]]; then
    	__zkit_msg "++ Loading setup:" ${name}
    	source ${ZKIT}/setup.d/${name}.sh
    else
    	__zkit_err "-- Cannot load setup:" ${name}
    fi
done

#EOF
