#!/usr/bin/env bash

#{{
# Setup zkit environment
#}}

set -e

export ZKIT=${ZKIT=${HOME}/.zkit}

## import user settings
rc="${HOME}/.zkitrc"
if [[ -r $rc ]]; then
    source $rc
fi

## check ZKIT
if [[ ! -d ${ZKIT} ]]; then
    echo "Cannot find ZKIT directory: $ZKIT"
    exit 1
fi

## load functions
source ${ZKIT}/bash/functions/zkit_core
require utils

## default settings
if [[ -z ${zkit_setups[*]} ]]; then
    if __zkit_have zsh; then
	zkit_setups=( default bash zsh )
    else
	zkit_setups=( default bash )
    fi
fi
: ${zkit_debug:=false}
: ${zkit_autoupdate:=true}
: ${zkit_private:=${HOME}/.zkit_private}
: ${zkit_private_repo:=}

## update zkit
if $zkit_autoupdate && [[ -d ${ZKIT}/.git ]]; then
    __zkit_msg "++ Updating ZKIT:" $name
    ( cd ${ZKIT} ; __zkit_run git pull )
    chmod -R og-rwx ${ZKIT}
fi

## make var directories
mkdir -p ${ZKIT}/var/{cache,tmp}

## pull private settings
if [[ -n ${zkit_private_repo} ]]; then
    if [[ -d ${zkit_private}/.git ]]; then
	__zkit_msg "++ Updating private"
	( cd ${zkit_private} ; __zkit_run git pull )
    else
	__zkit_err "++ Downloading private from ${zkit_private_repo}"
	__zkit_run git clone ${zkit_private_repo} ${zkit_private} || exit 1
    fi
    chmod -R og-rwx ${zkit_private}
fi

## get default setup params 
d=${zkit_private}/setup
if [[ -r ${d}/default ]]; then
    source ${d}/default
fi

## get host setup params 
host=${d}/host-${HOSTNAME}
if [[ ! -r ${host} ]]; then
    host=${d}/host-${HOSTNAME%%.*}
    if [[ ! -r ${host} ]]; then
	host=
    fi
fi
if [[ -n ${host} ]]; then
    __zkit_msg "++ Applying host intrinsic:" ${host}
    source ${host}
fi

## run setup scripts
for name in "${zkit_setups[@]}" "${zkit_setups_local[@]}"; do
    if [[ -r ${ZKIT}/setup.d/${name}.sh ]]; then
    	__zkit_msg "++ Loading setup:" ${name}
    	source ${ZKIT}/setup.d/${name}.sh
    else
    	__zkit_err "-- Cannot load setup:" ${name}
    fi
done

#EOF
